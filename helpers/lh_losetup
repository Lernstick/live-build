#!/bin/sh

# lh_losetup <device> <file> <partition>

set -e

# Source common functions
for FUNCTION in /usr/share/live-helper/functions/*.sh
do
	. ${FUNCTION}
done

# Reading configuration files
Read_conffile config/common
Set_defaults

if [ -z "${1}" ]
then
	DEVICE="`${LH_LOSETUP} -f`"
else
	DEVICE="${1}"
fi

FILE="${2}"
PARTITION="${3}"

${LH_LOSETUP} "${DEVICE}" "${FILE}"
FDISK_OUT="`fdisk -l -u ${DEVICE} 2>&1`"
${LH_LOSETUP} -d "${DEVICE}"

LOOPDEVICE="`echo ${DEVICE}p${PARTITION:=1}`"
CYL=`echo "$FDISK_OUT" | sed -ne "s_^$LOOPDEVICE[ *]*\([0-9]*\).*_\1_p"`
#OFFSET="`expr 512 '*' ${CYL}`"
OFFSET="$((CYL*512))"

echo loop $DEVICE at offset $OFFSET

if [ "${PARTITION}" = "0" ]
then
	${LH_LOSETUP} "${DEVICE}" "${FILE}"
else
	${LH_LOSETUP} -o "${OFFSET}" "${DEVICE}" "${FILE}"
fi
